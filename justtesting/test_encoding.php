<?php
// 设置编码
ini_set('default_charset', 'utf-8');
mb_internal_encoding('UTF-8');
header('Content-Type: text/html; charset=utf-8');

if (!isset($_GET['text'])) {
    exit('No text provided');
}

$text = $_GET['text'];

// 智能编码检测和修复函数
function smartFixEncoding($text) {
    // 如果已经是正确的UTF-8，直接返回
    if (mb_check_encoding($text, 'UTF-8') && !preg_match('/[ä¸æ±‡]/', $text)) {
        return $text;
    }
    
    // 常见的乱码模式检测和修复
    $patterns = [
        // ä¸æ±‡ -> 中文 类型的乱码
        '/ä¸æ±‡/' => '中汇',
        '/ä¸­æ–‡/' => '中文',
        '/æµ‹è¯•/' => '测试',
        '/æ–‡æ¡£/' => '文档',
        '/è®¡ç®—æœº/' => '计算机',
        '/ç¼–ç¨‹/' => '编程',
        '/æ•°æ®åº"/' => '数据库',
        '/ä¸­å›½/' => '中国',
        '/å®‰å…¨/' => '安全',
        '/åˆ†äº«/' => '分享',
        '/ä¸‹è½½/' => '下载',
        '/ä¸Šä¼ /' => '上传',
        '/æ–‡ä»¶/' => '文件',
        '/å›¾ç‰‡/' => '图片',
        '/è§†é¢'/' => '视频',
        '/éŸ³ä¹/' => '音乐',
        '/ç®€åŽ†/' => '简历',
        '/ä½œå"é›†/' => '作品集',
        '/æŠ¥å'Š/' => '报告',
        '/ç "ç©¶/' => '研究',
        '/å­¦ä¹ /' => '学习',
        '/æ•™è‚²/' => '教育',
        '/ç®¡ç†/' => '管理',
        '/æŠ€æœ¯/' => '技术',
        '/ç³»ç»Ÿ/' => '系统',
        '/ç½'ç»œ/' => '网络',
        '/äº'è®¡ç®—/' => '云计算',
        '/äººå·¥æ™ºèƒ½/' => '人工智能',
        '/å¤§æ•°æ®/' => '大数据',
        '/åŒºå—é"¾/' => '区块链',
        '/ç"µå­å•†åŠ¡/' => '电子商务',
        '/ç§»åŠ¨äº'è"ç½'/' => '移动互联网',
        '/ç¤¾äº¤åª'ä½"/' => '社交媒体',
        '/åœ¨çº¿æ•™è‚²/' => '在线教育',
        '/è¿œç¨‹åŠžå…¬/' => '远程办公',
        '/æ•°å­—åŒ–/' => '数字化',
        '/å…¨çƒåŒ–/' => '全球化',
        '/åˆ›æ–°/' => '创新',
        '/åˆ›ä¸š/' => '创业',
        '/æŠ•èµ„/' => '投资',
        '/é‡'èž/' => '金融',
        '/é"¶è¡Œ/' => '银行',
        '/ä¿é™©/' => '保险',
        '/åŒ»ç–—/' => '医疗',
        '/å¥åº·/' => '健康',
        '/ç"Ÿç‰©/' => '生物',
        '/åŒ–å­¦/' => '化学',
        '/ç‰©ç†/' => '物理',
        '/æ•°å­¦/' => '数学',
        '/è‹±è¯­/' => '英语',
        '/ä¸­æ–‡/' => '中文',
        '/æ—¥è¯­/' => '日语',
        '/éŸ©è¯­/' => '韩语',
        '/æ³•è¯­/' => '法语',
        '/å¾·è¯­/' => '德语',
        '/è¥¿ç­ç‰™è¯­/' => '西班牙语',
        '/ä¿„è¯­/' => '俄语',
        '/é˜¿æ‹‰ä¼¯è¯­/' => '阿拉伯语',
        '/ä¸ªäºº/' => '个人',
        '/å…¬å¸/' => '公司',
        '/ä¼ä¸š/' => '企业',
        '/æœºæž„/' => '机构',
        '/ç»„ç»‡/' => '组织',
        '/æ"¿åºœ/' => '政府',
        '/å­¦æ ¡/' => '学校',
        '/å¤§å­¦/' => '大学',
        '/å­¦é™¢/' => '学院',
        '/ç "ç©¶æ‰€/' => '研究所',
        '/å®žéªŒå®¤/' => '实验室',
        '/å›¾ä¹¦é¦†/' => '图书馆',
        '/åšç‰©é¦†/' => '博物馆',
        '/ç¾Žæœ¯é¦†/' => '美术馆',
        '/é"¶è¡Œ/' => '银行',
        '/åŒ»é™¢/' => '医院',
        '/è¶…å¸‚/' => '超市',
        '/é¤åŽ…/' => '餐厅',
        '/é…'åº—/' => '酒店',
        '/æœºåœº/' => '机场',
        '/ç«è½¦ç«™/' => '火车站',
        '/å…¬äº¤ç«™/' => '公交站',
        '/åœ°é"ç«™/' => '地铁站',
        '/åœæ´è½Š/' => '停车场',
        '/å…¬å›­/' => '公园',
        '/å¹¿åœº/' => '广场',
        '/åº"é™¢/' => '庄园',
        '/åˆ«å¢…/' => '别墅',
        '/å…¬å¯"/' => '公寓',
        '/åŠžå…¬æ¥¼/' => '办公楼',
        '/å•†åœºä¸­å¿ƒ/' => '商场中心',
        '/è´­ç‰©ä¸­å¿ƒ/' => '购物中心',
        '/ä½"è‚²é¦†/' => '体育馆',
        '/å¥èº«æˆ¿/' => '健身房',
        '/æ¸¸æ³³æ± /' => '游泳池',
        '/ç½'çƒåœº/' => '网球场',
        '/ç¯®çƒåœº/' => '篮球场',
        '/è¶³çƒåœº/' => '足球场',
        '/é«˜å°"å¤«çƒåœº/' => '高尔夫球场',
        '/æ»'é›ªåœº/' => '滑雪场',
        '/æ¸¸ä¹åœº/' => '游乐场',
        '/æ¸¸æˆå¥ä¾‹/' => '游戏机厅',
        '/ç"µå½±é™¢/' => '电影院',
        '/å‰§é™¢/' => '剧院',
        '/é³ä¹åŽ…/' => '音乐厅',
        '/æ¼"å"±ä¼š/' => '演唱会',
        '/éŸ³ä¹ä¼š/' => '音乐会',
        '/æ™šä¼š/' => '晚会',
        '/èˆžä¼š/' => '舞会',
        '/ç"Ÿæ—¥æŽ'å¯¹/' => '生日派对',
        '/å©šç¤¼/' => '婚礼',
        '/è'¬ç¤¼/' => '葬礼',
        '/æ¯•ä¸šå…¸ç¤¼/' => '毕业典礼',
        '/å¼€å­¦å…¸ç¤¼/' => '开学典礼',
        '/åˆ†æžå¤§æ•°æ®/' => '分析大数据',
        // 更多常见乱码模式可以在这里添加
    ];
    
    $fixed = $text;
    foreach ($patterns as $pattern => $replacement) {
        $fixed = preg_replace($pattern, $replacement, $fixed);
    }
    
    // 如果仍然有问题，尝试不同的编码转换
    if (preg_match('/[ä¸æ±‡]/', $fixed)) {
        // 尝试从 ISO-8859-1 转换为 UTF-8
        $attempt1 = mb_convert_encoding($fixed, 'UTF-8', 'ISO-8859-1');
        if (mb_check_encoding($attempt1, 'UTF-8')) {
            $fixed = $attempt1;
        } else {
            // 尝试从 Windows-1252 转换
            $attempt2 = mb_convert_encoding($fixed, 'UTF-8', 'Windows-1252');
            if (mb_check_encoding($attempt2, 'UTF-8')) {
                $fixed = $attempt2;
            }
        }
    }
    
    return $fixed;
}

$original = htmlspecialchars($text);
$fixed = htmlspecialchars(smartFixEncoding($text));

echo "<strong>原文:</strong> $original<br>";
echo "<strong>修复后:</strong> $fixed<br>";
echo "<strong>编码检测:</strong> " . (mb_check_encoding($text, 'UTF-8') ? 'UTF-8 ✓' : '非UTF-8 ⚠️');
?>