<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>密码验证测试 - Privnote</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .test-panel { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 5px;
        }
        .log-window {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Privnote 密码验证测试工具</h1>
        
        <div class="test-panel">
            <h3>测试1: Cookie 设置和检查</h3>
            <div class="mb-3">
                <button id="setCookie" class="btn btn-primary">设置 myth=ok Cookie</button>
                <button id="checkCookie" class="btn btn-secondary ms-2">检查 Cookie</button>
                <button id="clearCookie" class="btn btn-danger ms-2">清除 Cookie</button>
            </div>
            <div id="cookieStatus" class="alert alert-info">Cookie 状态: 未检查</div>
        </div>
        
        <div class="test-panel">
            <h3>测试2: 手动密码验证流程</h3>
            <div class="mb-3">
                <label for="noteId" class="form-label">笔记 ID</label>
                <input type="text" class="form-control" id="noteId" placeholder="输入笔记ID">
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">密码</label>
                <input type="password" class="form-control" id="password" placeholder="输入密码">
            </div>
            <button id="validatePassword" class="btn btn-primary">验证密码</button>
            <button id="retrieveContent" class="btn btn-success ms-2">获取内容</button>
        </div>
        
        <div class="test-panel">
            <h3>测试3: CORS 和 Cookie 传递测试</h3>
            <button id="testCors" class="btn btn-warning">测试跨域请求</button>
            <div id="corsStatus" class="alert alert-info mt-2">未测试</div>
        </div>
        
        <h3>日志输出</h3>
        <div id="logWindow" class="log-window"></div>
    </div>
    
    <script>
        // 日志功能
        function log(message) {
            const logWindow = document.getElementById('logWindow');
            const now = new Date();
            const timestamp = now.toTimeString().split(' ')[0];
            logWindow.innerHTML += `[${timestamp}] ${message}\n`;
            logWindow.scrollTop = logWindow.scrollHeight;
            console.log(message);
        }
        
        // 测试1: Cookie 操作
        document.getElementById('setCookie').addEventListener('click', function() {
            const expires = new Date(Date.now() + 3600000).toUTCString();
            document.cookie = "myth=ok; expires=" + expires + "; path=/; SameSite=Lax";
            log('设置 Cookie: myth=ok');
            updateCookieStatus();
        });
        
        document.getElementById('checkCookie').addEventListener('click', function() {
            updateCookieStatus();
        });
        
        document.getElementById('clearCookie').addEventListener('click', function() {
            document.cookie = "myth=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            log('清除 Cookie: myth');
            updateCookieStatus();
        });
        
        function updateCookieStatus() {
            const cookieStatus = document.getElementById('cookieStatus');
            const cookies = document.cookie;
            log('当前所有 Cookies: ' + cookies);
            
            const hasMythCookie = cookies.split(';').some(item => {
                const cookieStr = item.trim();
                return cookieStr.startsWith('myth=ok') || cookieStr.startsWith('myth=12345');
            });
            
            if (hasMythCookie) {
                cookieStatus.className = 'alert alert-success';
                cookieStatus.textContent = 'Cookie 状态: 已设置有效的myth cookie';
            } else {
                cookieStatus.className = 'alert alert-danger';
                cookieStatus.textContent = 'Cookie 状态: 未找到有效的myth cookie';
            }
        }
        
        // 测试2: 密码验证流程
        document.getElementById('validatePassword').addEventListener('click', async function() {
            const noteId = document.getElementById('noteId').value.trim();
            const password = document.getElementById('password').value;
            
            if (!noteId) {
                log('错误: 请输入笔记ID');
                return;
            }
            
            log(`开始验证密码 (笔记ID: ${noteId}, 密码: ${password})`);
            
            // 模拟验证成功
            const expires = new Date(Date.now() + 3600000).toUTCString();
            document.cookie = "myth=ok; expires=" + expires + "; path=/; SameSite=Lax";
            log('密码验证成功，已设置 myth=ok cookie');
            updateCookieStatus();
        });
        
        document.getElementById('retrieveContent').addEventListener('click', async function() {
            const noteId = document.getElementById('noteId').value.trim();
            
            if (!noteId) {
                log('错误: 请输入笔记ID');
                return;
            }
            
            log(`尝试获取笔记内容 (ID: ${noteId})`);
            
            try {
                const data = new FormData();
                data.append('e', noteId);
                data.append('mudi', 'y');
                
                log('发送请求到服务器...');
                const response = await fetch("https://maipdf.com/baidu.php", {
                    method: "POST",
                    body: data,
                    credentials: 'include'
                });
                
                const result = await response.text();
                log('服务器响应:');
                log(result.substring(0, 100) + (result.length > 100 ? '...' : ''));
                
                // 检查是否返回错误代码
                if (result.startsWith('18') || result.startsWith('19')) {
                    log('错误: 服务器返回认证错误码');
                } else {
                    log('成功: 接收到内容');
                }
            } catch (error) {
                log('错误: ' + error.message);
            }
        });
        
        // 测试3: CORS 测试
        document.getElementById('testCors').addEventListener('click', async function() {
            const corsStatus = document.getElementById('corsStatus');
            corsStatus.className = 'alert alert-info mt-2';
            corsStatus.textContent = '测试中...';
            
            log('开始CORS测试...');
            log('当前cookies: ' + document.cookie);
            
            try {
                const data = new FormData();
                data.append('test', 'cors_test');
                
                log('发送OPTIONS预检请求...');
                const response = await fetch("https://maipdf.com/baidu.php", {
                    method: "POST",
                    body: data,
                    credentials: 'include'
                });
                
                log('收到响应状态: ' + response.status);
                for (const [key, value] of response.headers.entries()) {
                    log(`响应头: ${key}: ${value}`);
                }
                
                corsStatus.className = 'alert alert-success mt-2';
                corsStatus.textContent = 'CORS请求成功!';
                log('CORS测试通过，可以进行跨域请求');
            } catch (error) {
                corsStatus.className = 'alert alert-danger mt-2';
                corsStatus.textContent = '错误: ' + error.message;
                log('CORS测试失败: ' + error.message);
            }
        });
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('测试工具已加载');
            updateCookieStatus();
        });
    </script>
</body>
</html>
